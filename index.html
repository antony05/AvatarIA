<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asistente Virtual 3D Offline</title>
  <script src="https://unpkg.com/@readyplayerme/viseme"></script>
  <style>
    body {
      margin: 0;
      background: #000;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }
    iframe {
      width: 100%;
      height: 80vh;
      border: none;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin-top: 10px;
    }
    #respuesta {
      padding: 1em;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <h1>Asistente Virtual 3D Offline</h1>
  <iframe
    id="avatar"
    allow="camera *; microphone *;"
    src="https://avataria-3hmq26.readyplayer.me/avatar?id=685d7da90a7a95e992d8045f"
  ></iframe>

  <div id="respuesta">Presion√° el bot√≥n y habl√°</div>
  <button onclick="iniciarHabla()">üé§ Hablar</button>

  <script>
    const iframe = document.getElementById("avatar");
    const respuestaDiv = document.getElementById("respuesta");

    window.addEventListener("message", (event) => {
      if (event.data.source === "readyplayerme") {
        if (event.data.eventName === "v1.frame.ready") {
          iframe.contentWindow.postMessage(
            { target: "readyplayerme", type: "subscribe", eventName: "v1.avatar.exported" },
            "*"
          );
          iframe.contentWindow.postMessage(
            { target: "readyplayerme", type: "subscribe", eventName: "v1.user.set" },
            "*"
          );
        }
      }
    });

    // Respuestas fijas para probar offline
    const respuestasSimuladas = {
      "hola": "¬°Hola! ¬øEn qu√© puedo ayudarte?",
      "c√≥mo est√°s": "Estoy bien, gracias por preguntar.",
      "qu√© puedes hacer": "Puedo escucharte y responderte con respuestas fijas.",
      "adi√≥s": "¬°Hasta luego! Que tengas un buen d√≠a.",
    };

    function iniciarHabla() {
      const reconocimiento = new (webkitSpeechRecognition || SpeechRecognition)();
      reconocimiento.lang = "es-ES";
      reconocimiento.start();

      reconocimiento.onresult = (evento) => {
        const textoUsuario = evento.results[0][0].transcript.toLowerCase();
        respuestaDiv.textContent = `T√∫ dijiste: ${textoUsuario}`;

        // Buscar respuesta simulada (o fallback)
        let textoRespuesta = "Lo siento, no entend√≠ eso.";

        for (const clave in respuestasSimuladas) {
          if (textoUsuario.includes(clave)) {
            textoRespuesta = respuestasSimuladas[clave];
            break;
          }
        }

        respuestaDiv.textContent = textoRespuesta;

        const mensaje = new SpeechSynthesisUtterance(textoRespuesta);
        mensaje.lang = "es-ES";

        mensaje.onstart = () => {
          iframe.contentWindow.postMessage(
            {
              target: "readyplayerme",
              type: "v1.viseme.start",
              payload: { text: textoRespuesta },
            },
            "*"
          );
        };
        mensaje.onend = () => {
          iframe.contentWindow.postMessage(
            {
              target: "readyplayerme",
              type: "v1.viseme.stop",
            },
            "*"
          );
        };

        speechSynthesis.speak(mensaje);
      };

      reconocimiento.onerror = () => {
        respuestaDiv.textContent = "Error al reconocer la voz. Intenta de nuevo.";
      };
    }
  </script>
</body>
</html>

