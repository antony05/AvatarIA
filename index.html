
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Asistente Virtual 3D</title>
  <script src="https://unpkg.com/@readyplayerme/viseme"></script>
  <style>
    body { margin: 0; background: #000; color: white; text-align: center; font-family: sans-serif; }
    iframe { width: 100%; height: 80vh; border: none; }
    button { font-size: 1.2em; padding: 10px 20px; margin-top: 10px; }
    #respuesta { padding: 1em; font-size: 1.1em; }
  </style>
</head>
<body>

  <h1>Asistente Virtual 3D</h1>
  <iframe id="avatar" allow="camera *; microphone *;" src="https://avataria-3hmq26.readyplayer.me/avatar?id=685d7da90a7a95e992d8045f"></iframe>

  <div id="respuesta">Presion√° el bot√≥n y habl√°</div>
  <button onclick="iniciarHabla()">üé§ Hablar</button>

  <script>
    const iframe = document.getElementById('avatar');
    const respuestaDiv = document.getElementById('respuesta');
    let avatarLoaded = false;

    window.addEventListener('message', (event) => {
      if (event.data.source === 'readyplayerme') {
        if (event.data.eventName === 'v1.frame.ready') {
          iframe.contentWindow.postMessage({ target: 'readyplayerme', type: 'subscribe', eventName: 'v1.avatar.exported' }, '*');
          iframe.contentWindow.postMessage({ target: 'readyplayerme', type: 'subscribe', eventName: 'v1.user.set' }, '*');
        }
        if (event.data.eventName === 'v1.avatar.exported') {
          avatarLoaded = true;
        }
      }
    });

    function iniciarHabla() {
      const reconocimiento = new (webkitSpeechRecognition || SpeechRecognition)();
      reconocimiento.lang = 'es-ES';
      reconocimiento.start();

      reconocimiento.onresult = async (evento) => {
        const textoUsuario = evento.results[0][0].transcript;
        respuestaDiv.textContent = `T√∫ dijiste: ${textoUsuario}`;

        const respuestaIA = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer 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"
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [{ role: "user", content: textoUsuario }]
          })
        });

        const datos = await respuestaIA.json();
        const textoRespuesta = datos.choices[0].message.content;
        respuestaDiv.textContent = textoRespuesta;

        const mensaje = new SpeechSynthesisUtterance(textoRespuesta);
        mensaje.lang = 'es-ES';

        mensaje.onstart = () => {
          iframe.contentWindow.postMessage({
            target: 'readyplayerme',
            type: 'v1.viseme.start',
            payload: { text: textoRespuesta }
          }, '*');
        };
        mensaje.onend = () => {
          iframe.contentWindow.postMessage({
            target: 'readyplayerme',
            type: 'v1.viseme.stop'
          }, '*');
        };

        speechSynthesis.speak(mensaje);
      };

      reconocimiento.onerror = () => {
        respuestaDiv.textContent = "Error al reconocer la voz. Intenta de nuevo.";
      };
    }
  </script>
</body>
</html>
